<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring - Kegiatan Belajar Siswa</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .header { 
            display: flex; align-items: center; 
            border-bottom: 2px solid #ddd; 
            padding-bottom: 15px; margin-bottom: 15px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .logo { max-width: 60px; height: auto; margin-right: 15px; }
        .header-text h1 { margin: 0; color: #0056b3; font-size: 24px; }
        .header-text p { margin: 0; }
        .table-responsive { max-height: 60vh; }
        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1056; /* Di atas modal backdrop */
            display: none; /* Sembunyi by default */
        }
    </style>
</head>
<body>

    <div class="container-fluid my-4">
        
        <div class="header">
            <img src="tutwuri.png" alt="Logo Sekolah" class="logo">
            <div class="header-text">
                <h1>Dashboard Monitoring Kegiatan Belajar Siswa</h1>
                <p>SMPN 10 BANAWA SELATAN</p>
            </div>
        </div>

        <ul class="nav nav-tabs mt-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="absensi-tab" data-bs-toggle="tab" data-bs-target="#absensi-content" type="button" role="tab">
                    <i class="bi bi-camera-video-fill"></i> Log Absensi
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="aktivitas-tab" data-bs-toggle="tab" data-bs-target="#aktivitas-content" type="button" role="tab">
                    <i class="bi bi-bar-chart-fill"></i> Log Aktivitas Siswa
                </button>
            </li>
        </ul>

        <div class="text-muted small mt-2">
            Status: <span id="status-text">Idle</span>
            <div class="spinner-border spinner-border-sm ms-2" role="status" id="loading-spinner" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="absensi-content" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark" style="position: sticky; top: 0;">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Nama</th>
                                        <th>Kelas</th>
                                        <th>UserID</th>
                                        <th>Koordinat (Lat, Long)</th>
                                        <th>Foto</th>
                                    </tr>
                                </thead>
                                <tbody id="absensi-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="aktivitas-content" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark" style="position: sticky; top: 0;">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Nama</th>
                                        <th>Kelas</th>
                                        <th>Aksi</th>
                                        <th>Poin</th>
                                        <th>MateriID</th>
                                        <th>UserID</th>
                                    </tr>
                                </thead>
                                <tbody id="aktivitas-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Preview Foto Absensi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="" id="imagePreview" class="img-fluid" alt="Foto Absensi">
                </div>
            </div>
        </div>
    </div>

    <div class="spinner-border text-primary" id="loading-indicator" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


    <script>
        // ##################################################################
        // PENTING! GANTI DENGAN URL WEB APP ANDA
        // ##################################################################
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyRTpWC5ZhmBV45y3Tt7Dgo_fEAXj3uD71K013WwqDDi5cCaKlgfG_J1biN7CF-tNFT1w/exec";
        // ##################################################################
        // Elemen DOM
        const absensiBody = document.getElementById("absensi-table-body");
        const aktivitasBody = document.getElementById("aktivitas-table-body");
        const statusText = document.getElementById("status-text");
        const loadingSpinner = document.getElementById("loading-spinner");
        const pageLoader = document.getElementById("loading-indicator");
        
        // Modal Instance
        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
        const imagePreview = document.getElementById('imagePreview');

        /**
         * ==========================================================
         * PERBAIKAN: Fungsi untuk menampilkan preview gambar
         * ==========================================================
         */
        function showImage(url) {
            try {
                const idPart = url.split('/d/')[1]; 
                const fileId = idPart.split('/')[0];
                // Gunakan /thumbnail untuk embed yang lebih stabil
                const previewUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w600`;
                
                imagePreview.src = previewUrl;
                imageModal.show();
            } catch (error) {
                console.error("Gagal mem-parsing URL Google Drive:", url, error);
                alert("Gagal memuat gambar. URL tidak valid.");
            }
        }
        // ==========================================================
        // AKHIR PERBAIKAN
        // ==========================================================

        /**
         * Fungsi untuk memformat Timestamp
         */
        function formatTanggal(isoString) {
            if (!isoString) return "-";
            const d = new Date(isoString);
            return d.toLocaleString('id-ID', { 
                dateStyle: 'medium', 
                timeStyle: 'short',
                hour12: false
            });
        }
        
        /**
         * Fungsi utama untuk mengambil dan merender semua data
         */
        async function fetchAndRenderData() {
            statusText.innerText = "Memuat data...";
            loadingSpinner.style.display = "inline-block";

            try {
                // Ambil data Absensi dan Aktivitas secara bersamaan
                const [absensiRes, aktivitasRes] = await Promise.all([
                    fetch(`${SCRIPT_URL}?action=getAbsensi`),
                    fetch(`${SCRIPT_URL}?action=getLogAktivitas`)
                ]);

                if (!absensiRes.ok || !aktivitasRes.ok) {
                    throw new Error("Gagal mengambil data dari server.");
                }

                const absensiData = await absensiRes.json();
JSON               const aktivitasData = await aktivitasRes.json();

                // 1. Render Tabel Absensi
                absensiBody.innerHTML = ""; // Kosongkan tabel
                if (absensiData.length > 0) {
                    absensiData.forEach(row => {
                        const tr = document.createElement("tr");
                        
                        // Cek FotoLink dan buat tombol mata
                        let fotoCell = '<td>-</td>'; // Default jika tidak ada link
                        if (row.FotoLink && row.FotoLink.includes('google.com')) {
                            fotoCell = `
                                <td>
A                                 <button class="btn btn-sm btn-outline-primary" onclick="showImage('${row.FotoLink}')">
                                        <i class="bi bi-eye-fill"></i> Lihat
                                    </button>
JSON                         </td>`;
                        }

                        tr.innerHTML = `
A                         <td>${formatTanggal(row.Timestamp)}</td>
                            <td>${row.Nama}</td>
                            <td>${row.Kelas}</td>
                            <td>${row.UserID}</td>
A                         <td>${row.Latitude}, ${row.Longitude}</td>
                            ${fotoCell}
                        `;
                        absensiBody.appendChild(tr);
                    });
                } else {
                    absensiBody.innerHTML = '<tr><td colspan="6" class="text-center">Belum ada data absensi.</td></tr>';
                }

                // 2. Render Tabel Aktivitas
                aktivitasBody.innerHTML = ""; // Kosongkan tabel
                if (aktivitasData.length > 0) {
                    aktivitasData.forEach(row => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${formatTanggal(row.Timestamp)}</td>
                            <td>${row.Nama}</td>
                            <td>${row.Kelas}</td>
                            <td>${row.Aksi}</td>
                            <td>${row.Poin}</td>
                            <td>${row.MateriID}</td>
id                         <td>${row.UserID}</td>
                        `;
                        aktivitasBody.appendChild(tr);
                    });
            _   } else {
                    aktivitasBody.innerHTML = '<tr><td colspan="7" class="text-center">Belum ada data aktivitas.</td></tr>';
                }

                statusText.innerText = `Idle (Terakhir update: ${formatTanggal(new Date())})`;

style       } catch (error) {
                console.error("Error fetching data:", error);
                statusText.innerText = `Error: ${error.message}`;
  S       } finally {
                loadingSpinner.style.display = "none";
                pageLoader.style.display = "none"; // Sembunyikan loader halaman
            }
        }

        // --- Inisialisasi ---
        document.addEventListener('DOMContentLoaded', () => {
            pageLoader.style.display = "block"; // Tampilkan loader saat pertama kali
            
            // 1. Muat data saat halaman dibuka
            fetchAndRenderData();

            // 2. Atur interval "Real-time" (Polling setiap 10 detik)
            // 10000 milidetik = 10 detik
            setInterval(fetchAndRenderData, 10000);
line-height   });

    </script>
</body>
</html> 
